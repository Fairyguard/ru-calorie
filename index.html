<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Diet Log</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* iOS Clean Style */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 20px; color: #000; }
        
        /* The Database Card */
        .db-info { font-size: 12px; color: #888; text-align: center; margin-bottom: 20px; }

        /* Main Controls */
        .controls { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; }
        #mic-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: none; 
            background: #007AFF; color: white; font-size: 32px; 
            box-shadow: 0 4px 15px rgba(0,122,255,0.4); cursor: pointer; 
            transition: all 0.2s; 
        }
        #mic-btn.recording { background: #ff3b30; transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255,59,48,0.3); }
        #status { margin-top: 15px; font-size: 16px; color: #555; height: 20px; }

        /* List Styling */
        .log-container { display: flex; flex-direction: column; gap: 15px; }
        .log-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .log-lines { 
            font-family: "Menlo", "Courier New", monospace; /* Monospace for alignment */
            font-size: 14px; 
            color: #333; 
            background: #f8f8f8; 
            padding: 10px; 
            border-radius: 8px; 
            white-space: pre-wrap; /* Keeps line breaks */
            margin-bottom: 10px;
        }

        .card-actions { display: flex; justify-content: space-between; align-items: center; }
        .btn { border: none; background: #e5e5ea; padding: 8px 16px; border-radius: 8px; font-weight: 600; color: #007AFF; cursor: pointer; }
        .btn-del { color: #ff3b30; background: none; }

        /* API Settings */
        .settings { margin-top: 40px; text-align: center; }
        #api-input { display: none; margin: 10px auto; width: 80%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="db-info">DATABASE LOADED: <span id="db-count">0</span> ITEMS</div>

    <div class="controls">
        <button id="mic-btn">üéôÔ∏è</button>
        <div id="status">Tap to Record</div>
    </div>

    <div id="log-container" class="log-container"></div>

    <div class="settings">
        <small onclick="document.getElementById('api-input').style.display='block'" style="color:#ccc">API Key (Optional)</small>
        <input type="password" id="api-input" placeholder="sk-..." onchange="localStorage.setItem('deepseek_key', this.value)">
    </div>

    <script>
        // ==========================================================
        // 1. YOUR DATABASE (EDIT THIS LIST)
        // Values are per 100 grams
        // ==========================================================
        const FOOD_DB = {
            // Food Name (lowercase) : { cal: Calories, prot: Protein }
            "plov":            { cal: 250, prot: 8 },
            "osh":             { cal: 250, prot: 8 },
            "samsa":           { cal: 280, prot: 10 },
            "somsa":           { cal: 280, prot: 10 },
            "boiled chicken":  { cal: 165, prot: 31 },
            "chicken breast":  { cal: 165, prot: 31 },
            "tovuq":           { cal: 165, prot: 31 },
            "beef":            { cal: 250, prot: 26 },
            "non":             { cal: 260, prot: 9 },
            "bread":           { cal: 260, prot: 9 },
            "lepeshka":        { cal: 260, prot: 9 },
            "egg":             { cal: 155, prot: 13 },
            "tuxum":           { cal: 155, prot: 13 },
            "rice":            { cal: 130, prot: 2 },
            "grechka":         { cal: 340, prot: 13 },
            "buckwheat":       { cal: 340, prot: 13 },
            "apple":           { cal: 52,  prot: 0 },
            "banana":          { cal: 89,  prot: 1 },
            "salad":           { cal: 20,  prot: 1 },
            "shashlik":        { cal: 240, prot: 20 }
        };

        // Standard portion sizes if you don't say grams
        const DEFAULT_GRAMS = 100; 
        const PORTION_SIZES = {
            "plov": 350, "osh": 350,
            "samsa": 100, "somsa": 100,
            "apple": 150, "egg": 50, "tuxum": 50
        };

        document.getElementById('db-count').innerText = Object.keys(FOOD_DB).length;

        // ==========================================================
        // 2. LOGIC
        // ==========================================================
        let history = JSON.parse(localStorage.getItem('diet_log_v5')) || [];
        const micBtn = document.getElementById('mic-btn');
        const statusEl = document.getElementById('status');
        let isRecording = false;

        // Speech Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; // Or 'ru-RU' if you prefer Russian
        recognition.continuous = true;

        micBtn.onclick = () => {
            if(isRecording) { recognition.stop(); } 
            else { recognition.start(); }
        };

        recognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('recording');
            statusEl.innerText = "Listening...";
        };

        recognition.onend = () => {
            isRecording = false;
            micBtn.classList.remove('recording');
            statusEl.innerText = "Tap to Record";
        };

        recognition.onresult = async (event) => {
            const last = event.results.length - 1;
            const text = event.results[last][0].transcript;
            if(event.results[last].isFinal){
                statusEl.innerText = "Processing: " + text;
                await processInput(text);
            }
        };

        // MAIN PROCESSING FUNCTION
        async function processInput(text) {
            text = text.toLowerCase();
            const time = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            let detectedItems = [];
            
            // 1. Try to find foods from YOUR DB in the text
            // Strategy: Check every key in FOOD_DB to see if it exists in the spoken text
            for (let foodKey in FOOD_DB) {
                if (text.includes(foodKey)) {
                    
                    // 2. Try to find grams near this food
                    // Regex looks for numbers near the food name or generic numbers
                    // Simple approach: Look for "Number grams" or just default
                    
                    let grams = PORTION_SIZES[foodKey] || DEFAULT_GRAMS; // Default
                    
                    // Regex: "200 grams plov" or "plov 200" or "200 plov"
                    // We extract all numbers from the string to guess
                    const numbers = text.match(/\d+/g);
                    if (numbers && numbers.length > 0) {
                        // Very naive: take the first number found as grams
                        // Refinement: If user says "2 samsa", we might want 2 * 100
                        // For now, let's assume user says "200 grams"
                         
                        // If number is small (<10), assume "pieces" and multiply by default size
                        const num = parseInt(numbers[0]);
                        if (num < 10) {
                             grams = num * (PORTION_SIZES[foodKey] || 100);
                        } else {
                             grams = num;
                        }
                    }

                    // Calculate Macros based on DB
                    const factor = grams / 100;
                    const cals = Math.round(FOOD_DB[foodKey].cal * factor);
                    const prot = Math.round(FOOD_DB[foodKey].prot * factor);

                    detectedItems.push({
                        name: foodKey,
                        grams: grams,
                        cal: cals,
                        prot: prot
                    });
                }
            }

            if (detectedItems.length > 0) {
                addToHistory(detectedItems, time);
            } else {
                // Try AI if local fail (optional)
                const apiKey = localStorage.getItem('deepseek_key');
                if(apiKey && navigator.onLine) {
                    await askAI(text, time);
                } else {
                    statusEl.innerText = "Food not in DB. Try 'Boiled Chicken'";
                }
            }
        }

        async function askAI(text, time) {
            // This is a fallback to parse weird sentences, but we still force DB values if name matches
            const apiKey = localStorage.getItem('deepseek_key');
            try {
                const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ 
                            role: "system", 
                            content: "Extract foods: JSON array [{'name':'food_key','grams':int}]. Use english keys. If grams unknown use 100." 
                        }, { role: "user", content: text }]
                    })
                });
                const data = await res.json();
                let items = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
                
                // Recalculate using LOCAL DB to ensure accuracy
                let finalItems = items.map(i => {
                    let dbItem = FOOD_DB[i.name] || { cal: 100, prot: 5 }; // Fallback if AI invents food
                    let factor = i.grams / 100;
                    return {
                        name: i.name,
                        grams: i.grams,
                        cal: Math.round(dbItem.cal * factor),
                        prot: Math.round(dbItem.prot * factor)
                    };
                });
                addToHistory(finalItems, time);

            } catch(e) { console.error(e); }
        }

        function addToHistory(items, time) {
            const entry = {
                id: Date.now(),
                time: time,
                items: items
            };
            history.unshift(entry);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('diet_log_v5', JSON.stringify(history));
            const container = document.getElementById('log-container');
            container.innerHTML = "";

            history.forEach(entry => {
                let totalCal = 0;
                let totalProt = 0;
                let foodText = "";

                entry.items.forEach(item => {
                    totalCal += item.cal;
                    totalProt += item.prot;
                    // Format: "plov 100 gr"
                    foodText += `${item.name} ${item.grams} gr\n`;
                });

                // Format: "22:54 800 cal protein 62 gr"
                const summaryLine = `${entry.time} ${totalCal} cal protein ${totalProt} gr`;
                const fullText = foodText + summaryLine;

                const div = document.createElement('div');
                div.className = 'log-card';
                div.innerHTML = `
                    <div class="log-lines">${fullText}</div>
                    <div class="card-actions">
                        <button class="btn btn-del" onclick="del(${entry.id})">Delete</button>
                        <button class="btn" onclick="copyText(this, \`${fullText.replace(/\n/g, '\\n')}\`)">Copy</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function copyText(btn, text) {
            navigator.clipboard.writeText(text);
            const original = btn.innerText;
            btn.innerText = "Copied!";
            btn.style.background = "#34c759";
            btn.style.color = "white";
            setTimeout(() => {
                btn.innerText = original;
                btn.style.background = "#e5e5ea";
                btn.style.color = "#007AFF";
            }, 1000);
        }

        function del(id) {
            if(confirm('Delete?')) {
                history = history.filter(x => x.id !== id);
                saveAndRender();
            }
        }

        // Init
        saveAndRender();

    </script>
</body>
</html>
