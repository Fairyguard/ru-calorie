<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Diet Log</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* iOS Clean Style */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 20px; color: #000; }
        
        .db-info { font-size: 12px; color: #888; text-align: center; margin-bottom: 20px; }

        /* Main Controls */
        .controls { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; }
        #mic-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: none; 
            background: #007AFF; color: white; font-size: 32px; 
            box-shadow: 0 4px 15px rgba(0,122,255,0.4); cursor: pointer; 
            transition: all 0.2s; 
        }
        #mic-btn.recording { background: #ff3b30; transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255,59,48,0.3); }
        
        /* STATUS INDICATORS */
        #status { margin-top: 15px; font-size: 16px; color: #555; height: 20px; font-weight: 500; }
        .status-thinking { color: #007AFF; }
        .status-calling  { color: #5856D6; animation: blink 1s infinite; } /* Purple Blink */
        .status-error    { color: #FF3B30; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* List Styling */
        .log-container { display: flex; flex-direction: column; gap: 15px; }
        .log-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .log-lines { 
            font-family: "Menlo", "Courier New", monospace; 
            font-size: 14px; color: #333; background: #f8f8f8; 
            padding: 10px; border-radius: 8px; 
            white-space: pre-wrap; margin-bottom: 10px;
        }

        .card-actions { display: flex; justify-content: space-between; align-items: center; }
        .btn { border: none; background: #e5e5ea; padding: 8px 16px; border-radius: 8px; font-weight: 600; color: #007AFF; cursor: pointer; }
        .btn-del { color: #ff3b30; background: none; }

        /* AI Badge on Card */
        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #5856D6, #AF52DE);
            color: white; font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 4px;
            margin-left: 8px; vertical-align: middle;
            text-transform: uppercase;
        }

        .settings { margin-top: 40px; text-align: center; }
        #api-input { display: none; margin: 10px auto; width: 80%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="db-info">DATABASE LOADED: <span id="db-count">0</span> ITEMS</div>

    <div class="controls">
        <button id="mic-btn">üéôÔ∏è</button>
        <div id="status">Tap to Record</div>
    </div>

    <div id="log-container" class="log-container"></div>

    <div class="settings">
        <small onclick="document.getElementById('api-input').style.display='block'" style="color:#ccc">API Key (Optional)</small>
        <input type="password" id="api-input" placeholder="sk-..." onchange="localStorage.setItem('deepseek_key', this.value)">
    </div>

    <script>
        const FOOD_DB = {
            "plov":            { cal: 250, prot: 8 },
            "osh":             { cal: 250, prot: 8 },
            "samsa":           { cal: 280, prot: 10 },
            "boiled buckwheat":{ cal: 90, prot: 3.4 },
            "olive oil":       { cal: 89, prot: 0 },
            "fried chicken":   { cal: 200, prot: 31 },
            "kimchi":          { cal: 30, prot: 1 },
            "carrot":          { cal: 44, prot: 1.2 },
            "heavy oats":      { cal: 334, prot: 12 },
            "light oats":      { cal: 370, prot: 13 },
            "boiled chicken":  { cal: 165, prot: 31 },
            "chicken breast":  { cal: 165, prot: 31 },
            "tovuq":           { cal: 165, prot: 31 },
            "beef":            { cal: 250, prot: 26 },
            "non":             { cal: 260, prot: 9 },
            "bread":           { cal: 260, prot: 9 },
            "lepeshka":        { cal: 260, prot: 9 },
            "egg":             { cal: 155, prot: 13 },
            "tuxum":           { cal: 155, prot: 13 },
            "rice":            { cal: 130, prot: 2 },
            "grechka":         { cal: 340, prot: 13 },
            "buckwheat":       { cal: 340, prot: 13 },
            "apple":           { cal: 52,  prot: 0 },
            "banana":          { cal: 89,  prot: 1 },
            "salad":           { cal: 20,  prot: 1 },
            "shashlik":        { cal: 240, prot: 20 }
        };

        const DEFAULT_GRAMS = 100; 
        const PORTION_SIZES = {
            "plov": 350, "osh": 350,
            "samsa": 100, "somsa": 100,
            "apple": 150, "egg": 50, "tuxum": 50
        };

        document.getElementById('db-count').innerText = Object.keys(FOOD_DB).length;

        let history = JSON.parse(localStorage.getItem('diet_log_v5')) || [];
        const micBtn = document.getElementById('mic-btn');
        const statusEl = document.getElementById('status');
        let isRecording = false;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; 
        recognition.continuous = true;

        micBtn.onclick = () => {
            if(isRecording) { recognition.stop(); } 
            else { recognition.start(); }
        };

        recognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('recording');
            statusEl.innerText = "Listening...";
            statusEl.className = "";
        };

        recognition.onend = () => {
            isRecording = false;
            micBtn.classList.remove('recording');
            if(statusEl.innerText === "Listening...") statusEl.innerText = "Tap to Record";
        };

        recognition.onresult = async (event) => {
            const last = event.results.length - 1;
            const text = event.results[last][0].transcript;
            if(event.results[last].isFinal){
                // SHOW: Processing
                statusEl.innerText = "Processing: " + text;
                await processInput(text);
            }
        };

        async function processInput(text) {
            text = text.toLowerCase();
            const time = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            let detectedItems = [];
            
            // 1. Local Search
            for (let foodKey in FOOD_DB) {
                if (text.includes(foodKey)) {
                    let grams = PORTION_SIZES[foodKey] || DEFAULT_GRAMS; 
                    const numbers = text.match(/\d+/g);
                    if (numbers && numbers.length > 0) {
                        const num = parseInt(numbers[0]);
                        if (num < 10) grams = num * (PORTION_SIZES[foodKey] || 100);
                        else grams = num;
                    }

                    const factor = grams / 100;
                    detectedItems.push({
                        name: foodKey,
                        grams: grams,
                        cal: Math.round(FOOD_DB[foodKey].cal * factor),
                        prot: Math.round(FOOD_DB[foodKey].prot * factor)
                    });
                }
            }

            if (detectedItems.length > 0) {
                // False means "Not AI"
                addToHistory(detectedItems, time, false);
                statusEl.innerText = "Saved (Local DB)";
                statusEl.className = "";
            } else {
                // 2. AI Fallback
                const apiKey = "sk-1db5fd50095842cfb1cab3a007df4970";
                
                if(apiKey && navigator.onLine) {
                    // SHOW: Triggering AI
                    statusEl.innerText = "ü§ñ Local search failed. Activating AI...";
                    statusEl.className = "status-thinking";
                    await askAI(text, time);
                } else {
                    statusEl.innerText = "‚ùå Not found. Try 'Boiled Chicken'";
                    statusEl.className = "status-error";
                }
            }
        }

        async function askAI(text, time) {
            const apiKey = "sk-1db5fd50095842cfb1cab3a007df4970";
            try {
                // SHOW: The Network Call
                statusEl.innerText = "üì° Calling DeepSeek LLM...";
                statusEl.className = "status-calling";

                const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ 
                            role: "system", 
                            content: "Extract foods: JSON array [{'name':'food_key','grams':int}]. Use english keys. If grams unknown use 100." 
                        }, { role: "user", content: text }]
                    })
                });
                
                if (!res.ok) throw new Error("API Limit or Key Error");

                const data = await res.json();
                let items = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
                
                let finalItems = items.map(i => {
                    let dbItem = FOOD_DB[i.name] || { cal: 100, prot: 5 }; 
                    let factor = i.grams / 100;
                    return {
                        name: i.name,
                        grams: i.grams,
                        cal: Math.round(dbItem.cal * factor),
                        prot: Math.round(dbItem.prot * factor)
                    };
                });
                
                // True means "Is AI"
                addToHistory(finalItems, time, true);
                
                statusEl.innerText = "‚úÖ AI Success";
                statusEl.className = "";
                setTimeout(() => statusEl.innerText = "Tap to Record", 2000);

            } catch(e) { 
                console.error(e);
                // SHOW: Failure
                statusEl.innerText = "‚ùå AI Failed: " + e.message;
                statusEl.className = "status-error";
            }
        }

        // Added isAI parameter
        function addToHistory(items, time, isAI = false) {
            const entry = {
                id: Date.now(),
                time: time,
                items: items,
                isAI: isAI // Save the source
            };
            history.unshift(entry);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('diet_log_v5', JSON.stringify(history));
            const container = document.getElementById('log-container');
            container.innerHTML = "";

            history.forEach(entry => {
                let totalCal = 0;
                let totalProt = 0;
                let foodText = "";

                entry.items.forEach(item => {
                    totalCal += item.cal;
                    totalProt += item.prot;
                    foodText += `${item.name} ${item.grams} gr\n`;
                });

                // Show Badge if AI was used
                const aiBadge = entry.isAI ? '<span class="ai-badge">‚ú® AI</span>' : '';
                
                const summaryLine = `${entry.time} ${aiBadge} ${totalCal} cal protein ${totalProt} gr`;
                const fullText = foodText + summaryLine.replace(/<[^>]*>?/gm, ''); // clean text for copy

                const div = document.createElement('div');
                div.className = 'log-card';
                div.innerHTML = `
                    <div class="log-lines">${foodText}${summaryLine}</div>
                    <div class="card-actions">
                        <button class="btn btn-del" onclick="del(${entry.id})">Delete</button>
                        <button class="btn" onclick="copyText(this, \`${fullText.replace(/\n/g, '\\n')}\`)">Copy</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function copyText(btn, text) {
            navigator.clipboard.writeText(text);
            const original = btn.innerText;
            btn.innerText = "Copied!";
            btn.style.background = "#34c759";
            btn.style.color = "white";
            setTimeout(() => {
                btn.innerText = original;
                btn.style.background = "#e5e5ea";
                btn.style.color = "#007AFF";
            }, 1000);
        }

        function del(id) {
            if(confirm('Delete?')) {
                history = history.filter(x => x.id !== id);
                saveAndRender();
            }
        }

        saveAndRender();

    </script>
</body>
</html>
