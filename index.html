<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uzbek Diet Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 15px; color: #1c1c1e; }
        
        /* HEADER STATS */
        .header-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        .big-number { font-size: 36px; font-weight: 800; color: #007AFF; margin: 5px 0; }
        .macros-row { display: flex; justify-content: center; gap: 15px; font-size: 14px; color: #666; margin-top: 5px; }
        .macro-item span { font-weight: 600; color: #000; }

        /* MIC BUTTON */
        .controls { text-align: center; margin-bottom: 25px; }
        #mic-btn { 
            width: 72px; height: 72px; border-radius: 50%; border: none; 
            background: #007AFF; color: white; font-size: 30px; 
            box-shadow: 0 6px 20px rgba(0,122,255,0.4); cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #mic-btn:active { transform: scale(0.92); }
        #mic-btn.recording { background: #ff3b30; box-shadow: 0 0 0 8px rgba(255, 59, 48, 0.3); animation: pulse 2s infinite; }
        #status-text { margin-top: 10px; font-size: 14px; color: #8e8e93; min-height: 20px; }

        /* LOG LIST */
        .log-list { display: flex; flex-direction: column; gap: 12px; }
        .log-card { background: white; border-radius: 16px; padding: 16px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .log-time { font-size: 13px; color: #8e8e93; font-weight: 600; }
        .log-cals { font-weight: 700; color: #007AFF; font-size: 15px; }
        .log-body { font-size: 15px; line-height: 1.4; color: #1c1c1e; margin-bottom: 8px; }
        .log-footer { border-top: 1px solid #f2f2f7; padding-top: 8px; display: flex; justify-content: space-between; align-items: center; }
        .log-macros { font-size: 12px; color: #666; font-family: monospace; }
        
        /* ACTIONS */
        .btn-action { background: #f2f2f7; border: none; border-radius: 8px; padding: 6px 12px; font-size: 12px; font-weight: 600; color: #007AFF; cursor: pointer; }
        .btn-delete { color: #ff3b30; background: none; }

        /* SETTINGS */
        .settings { margin-top: 40px; text-align: center; }
        #api-input { padding: 10px; width: 80%; border: 1px solid #e5e5ea; border-radius: 10px; font-size: 14px; text-align: center; display: none; margin: 10px auto; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="header-card">
        <div style="font-size:12px; color:#8e8e93; text-transform:uppercase; letter-spacing:1px;">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="big-number" id="total-cal">0</div>
        <div class="macros-row">
            <div class="macro-item">Protein <span>0g</span></div>
            <div class="macro-item">Carbs <span>0g</span></div>
            <div class="macro-item">Fat <span>0g</span></div>
        </div>
    </div>

    <div class="controls">
        <button id="mic-btn">üéôÔ∏è</button>
        <div id="status-text">–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
    </div>

    <div id="log-container" class="log-list"></div>

    <div class="settings">
        <small onclick="toggleSettings()" style="color:#c7c7cc">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI</small>
        <input type="password" id="api-input" placeholder="–í—Å—Ç–∞–≤—å DeepSeek API Key" onchange="saveKey(this.value)">
    </div>

    <script>
        // --- DATA & STATE ---
        let history = JSON.parse(localStorage.getItem('uz_history_v3')) || [];
        let apiKey = localStorage.getItem('deepseek_key') || "";
        let isRecording = false;

        // Offline Database (100g basis)
        const db = {
            "–ø–ª–æ–≤": {c:250, p:8, f:15, carb:25},
            "–æ—à": {c:250, p:8, f:15, carb:25},
            "—Å–∞–º—Å–∞": {c:280, p:10, f:18, carb:22},
            "–ª–∞–≥–º–∞–Ω": {c:160, p:6, f:8, carb:15},
            "–º–∞–Ω—Ç—ã": {c:230, p:9, f:10, carb:25},
            "—à–∞—à–ª—ã–∫": {c:240, p:20, f:17, carb:2},
            "–Ω–æ–Ω": {c:260, p:8, f:1, carb:50},
            "—Ö–ª–µ–±": {c:260, p:8, f:1, carb:50},
            "—è–π—Ü–æ": {c:155, p:13, f:11, carb:1},
            "—Ç–≤–æ—Ä–æ–≥": {c:100, p:16, f:1, carb:3},
            "—è–±–ª–æ–∫–æ": {c:52, p:0, f:0, carb:14},
            "–±–∞–Ω–∞–Ω": {c:90, p:1, f:0, carb:23},
            "–∫–æ–ª–∞": {c:42, p:0, f:0, carb:10},
            "—á–∞–π": {c:1, p:0, f:0, carb:0},
            "–∫–æ—Ñ–µ": {c:2, p:0, f:0, carb:0}
        };

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = true; // Keep listening until user stops
        recognition.interimResults = true;

        const micBtn = document.getElementById('mic-btn');
        const statusEl = document.getElementById('status-text');

        // TOGGLE LOGIC (Fix for "Doesn't stop")
        micBtn.onclick = () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        };

        function startRecording() {
            try {
                recognition.start();
                isRecording = true;
                micBtn.classList.add('recording');
                statusEl.innerText = "–°–ª—É—à–∞—é... (–ù–∞–∂–º–∏ –µ—â–µ —Ä–∞–∑ —á—Ç–æ–±—ã —Å—Ç–æ–ø)";
            } catch (e) { console.error(e); }
        }

        function stopRecording() {
            recognition.stop();
            isRecording = false;
            micBtn.classList.remove('recording');
            statusEl.innerText = "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...";
        }

        let finalTranscript = "";

        recognition.onresult = (event) => {
            let interim = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + " ";
                } else {
                    interim += event.results[i][0].transcript;
                }
            }
            if (isRecording) statusEl.innerText = interim || "–°–ª—É—à–∞—é...";
        };

        recognition.onend = () => {
            if (isRecording) {
                // If stopped by silence but flag is true, restart (unless user pressed stop)
                // actually better to just process what we have if user stopped talking
                stopRecording(); 
            }
            if (finalTranscript.trim().length > 0) {
                processText(finalTranscript);
                finalTranscript = "";
            } else {
                statusEl.innerText = "–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏";
            }
        };

        // --- PROCESSING ---
        async function processText(text) {
            const time = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            if (navigator.onLine && apiKey) {
                await askDeepSeek(text, time);
            } else {
                askLocal(text, time);
            }
        }

        // 1. AI MODE
        async function askDeepSeek(text, time) {
            try {
                const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ 
                            role: "system", 
                            content: `Analyze text. Return JSON array: [{"food":"Name","grams":int,"c":int,"p":int,"f":int,"carb":int}]. 
                            Calculate macros based on grams. Plov=250kcal/100g. Default portion=300g. 
                            Output ONLY JSON.` 
                        }, { role: "user", content: text }]
                    })
                });
                const data = await res.json();
                const jsonStr = data.choices[0].message.content.replace(/```json|```/g, '').trim();
                const items = JSON.parse(jsonStr);
                addRecord(items, time);
            } catch (e) {
                console.log("AI Error", e);
                askLocal(text, time); // Fallback
            }
        }

        // 2. OFFLINE MODE
        function askLocal(text, time) {
            text = text.toLowerCase();
            let items = [];
            
            for (let [key, val] of Object.entries(db)) {
                if (text.includes(key)) {
                    let grams = 100;
                    // Extract number
                    const nums = text.match(/(\d+)\s*(–≥|–≥—Ä|–≥—Ä–∞–º–º)?/);
                    if (nums) grams = parseInt(nums[1]);
                    // Defaults
                    else if (['–ø–ª–æ–≤','–æ—à','–ª–∞–≥–º–∞–Ω'].includes(key)) grams = 350;
                    else if (['—Å–∞–º—Å–∞','—è–±–ª–æ–∫–æ','—è–π—Ü–æ'].includes(key)) grams = 100;

                    const factor = grams / 100;
                    items.push({
                        food: key.charAt(0).toUpperCase() + key.slice(1),
                        grams: grams,
                        c: Math.round(val.c * factor),
                        p: Math.round(val.p * factor),
                        f: Math.round(val.f * factor),
                        carb: Math.round(val.carb * factor)
                    });
                }
            }
            if (items.length > 0) addRecord(items, time);
            else statusEl.innerText = "–ù–µ –ø–æ–Ω—è–ª. –ü–æ–ø—Ä–æ–±—É–π '300–≥ –ø–ª–æ–≤–∞'";
        }

        // --- UI & STORAGE ---
        function addRecord(items, time) {
            // Calculate entry totals
            let entryTotal = {c:0, p:0, f:0, carb:0};
            items.forEach(i => {
                entryTotal.c += i.c; entryTotal.p += i.p; entryTotal.f += i.f; entryTotal.carb += i.carb;
            });

            const record = {
                id: Date.now(),
                time: time,
                items: items,
                total: entryTotal
            };

            history.unshift(record);
            save();
            statusEl.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
        }

        function render() {
            const container = document.getElementById('log-container');
            container.innerHTML = "";
            let dayTotal = {c:0, p:0, f:0, carb:0};

            history.forEach(rec => {
                // Update Day Stats
                dayTotal.c += rec.total.c; dayTotal.p += rec.total.p; 
                dayTotal.f += rec.total.f; dayTotal.carb += rec.total.carb;

                // Build Item String
                let foodStr = rec.items.map(i => `${i.food} (${i.grams}–≥)`).join(", ");
                
                // Build Copy String
                const copyText = `[${rec.time}] ${foodStr}\nüî• ${rec.total.c} –∫–∫–∞–ª | –ë:${rec.total.p} –ñ:${rec.total.f} –£:${rec.total.carb}`;

                // HTML
                const card = document.createElement('div');
                card.className = 'log-card';
                card.innerHTML = `
                    <div class="log-header">
                        <span class="log-time">üïí ${rec.time}</span>
                        <span class="log-cals">${rec.total.c} –∫–∫–∞–ª</span>
                    </div>
                    <div class="log-body">${foodStr}</div>
                    <div class="log-footer">
                        <div class="log-macros">P:${rec.total.p} ‚Ä¢ F:${rec.total.f} ‚Ä¢ C:${rec.total.carb}</div>
                        <div>
                            <button class="btn-action btn-delete" onclick="del(${rec.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-action" onclick="copyToClip('${copyText.replace(/\n/g, "\\n")}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Update Header
            document.querySelector('.big-number').innerText = dayTotal.c;
            const macros = document.querySelectorAll('.macro-item span');
            macros[0].innerText = dayTotal.p + 'g';
            macros[1].innerText = dayTotal.carb + 'g';
            macros[2].innerText = dayTotal.f + 'g';
        }

        function copyToClip(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ:\n" + text);
            });
        }

        function del(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) {
                history = history.filter(x => x.id !== id);
                save();
            }
        }

        function save() {
            localStorage.setItem('uz_history_v3', JSON.stringify(history));
            render();
        }

        function saveKey(k) { localStorage.setItem('deepseek_key', k); apiKey = k; }
        function toggleSettings() { 
            const el = document.getElementById('api-input');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        
        if(apiKey) document.getElementById('api-input').value = apiKey;
        render(); // Init
    </script>
</body>
</html>
